AWSTemplateFormatVersion: '2010-09-09'
Description: 'Datastax template, License: Apache 2.0 (Please do not remove) July,2,2020 (qs-1nbqhl4up)'
Metadata:
  QuickStartDocumentation:
    EntrypointName: "Launch into new VPC"
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: ' VPC Network Configuration'
        Parameters:
          - AvailabilityZones
          - AccessLocation
      - Label:
          default: Datastax Setup
        Parameters:
          - ClusterName
          - KeyName
          - DSAcademyUser
          - DSAcademyPW
          - DSEVersion
          - DBPassword
      - Label:
          default: OpsCenter Setup
        Parameters:
          - OpsCenterInstanceType
          - OpsCPassword
      - Label:
          default: 1st Datacenter & Node Setup
        Parameters:
          - DC0Size
          - DC0Name
          - DC0Instance
          - DC0VolumeSize
          - DC0Search
          - DC0Analytics
      - Label:
          default: (Optional) 2nd Datacenter & Node Setup
        Parameters:
          - DC1Size
          - DC1Name
          - DC1Instance
          - DC1VolumeSize
          - DC1Search
          - DC1Analytics
      - Label:
          default: AWS Quick Start Configuration
        Parameters:
          - QSS3BucketName
          - QSS3BucketRegion
          - QSS3KeyPrefix
    ParameterLabels:
      AccessLocation:
        default: Permitted IP range
      AvailabilityZones:
        default: Availability Zones
      KeyName:
        default: Key Name
      DSEVersion:
        default: DSE version
      DSAcademyUser:
        default: DataStax Academy Username
      DBPassword:
        default: Database Password
      DSAcademyPW:
        default: DataStax Academy Password
      OpsCPassword:
        default: OpsCenter Password
      DC0Size:
        default: 1st Data Center Size
      DC0Name:
        default: 1st Data Center Name
      DC0Instance:
        default: 1st Data Center Instances Type
      DC0VolumeSize:
        default: 1st Data Center Volume Size
      DC0Search:
        default: False
      DC0Analytics:
        default: False
      DC1Size:
        default: 2nd Data Center Size
      DC1Name:
        default: 2nd Data Center Name
      DC1Instance:
        default: 2nd Data Center Instances Type
      DC1VolumeSize:
        default: 2nd Data Center Volume Size
      DC1Search:
        default: False
      DC1Analytics:
        default: False
      ClusterName:
        default: Cluster Name
      QSS3BucketName:
        default: Quick Start S3 Bucket Name
      QSS3BucketRegion:
        default: Quick Start S3 bucket region
      QSS3KeyPrefix:
        default: Quick Start S3 Key Prefix
Parameters:
  KeyName:
    Description: Public/private key pair, which allows you to connect securely to
      your instance after it launches.
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  AccessLocation:
    Description: The CIDR IP range that is permitted to access the DSE OpsCenter web
      console or SSH to the EC2 instance for the console.
    Type: String
    MinLength: '9'
    MaxLength: '18'
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
  AvailabilityZones:
    Type: List<AWS::EC2::AvailabilityZone::Name>
    Description: The list of Availability Zones to use for the subnets in the VPC.
      The Quick Start uses three Availability Zones from your list and preserves the
      logical order you specify.
  DSEVersion:
    Type: String
    Description: DSE version to install.
    Default: 5.1.29
    AllowedValues:
      - 5.1.29
      - 6.8.20
  DSAcademyUser:
    Type: String
    Description: User name for your academy.datastax.com account.
  DSAcademyPW:
    Type: String
    Description: Password for your academy.datastax.com account.
    NoEcho: true
  DBPassword:
    Type: String
    Description: Password for the default Cassandra user 'cassandra'.
    NoEcho: true
  OpsCPassword:
    Type: String
    Description: Password for default DSE OpsCenter administrator.
    NoEcho: true
  DC0Size:
    Description: The number of nodes to create in the 1st DSE datacenter.
    Type: Number
    Default: 3
    AllowedValues:
      - 3
      - 4
      - 5
      - 6
      - 7
      - 8
      - 9
    ConstraintDescription: Value must be an integer from 3-9
  DC0Name:
    Description: Name of the 1st Data Center.
    Type: String
    Default: DC0
  DC0Instance:
    Description: EC2 instance type for the nodes in each DSE datacenter.
    Type: String
    AllowedValues:
      - t2.medium
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - i3.xlarge
      - i3.2xlarge
      - i3.4xlarge
      - r5.large
      - r5.xlarge
      - r5.2xlarge
      - r5.4xlarge
      - r5.8xlarge
    Default: r5.2xlarge
  DC0VolumeSize:
    Description: The EBS volume size, in GiB, for the nodes in each datacenter.
    Type: Number
    AllowedValues:
      - 1024
      - 2048
    Default: 1024
  DC0Search:
    Description: True if this is a search DC
    Type: String
    AllowedValues:
      - True
      - False
    Default: False
  DC0Analytics:
    Description: True if this is an analytics DC
    Type: String
    AllowedValues:
      - True
      - False
    Default: False
  DC1Size:
    Description: >-
      The number of nodes to create in the 2nd DSE datacenter. Select 0 if you need
      only 1 Data Center. If you want to split your workloads with different set of
      nodes, you can choose to deploy a 2nd Data Center. The 2nd Data Center can have
      different configuration i.e instance type, volume size etc. for the nodes.
    Type: Number
    Default: 0
    AllowedValues:
      - 0
      - 3
      - 4
      - 5
      - 6
      - 7
      - 8
      - 9
    ConstraintDescription: Value must be an integer from 3-9 or 0 if you dont need
      a second datacenter.
  DC1Name:
    Description: Name of the 2nd Data Center.
    Type: String
    Default: DC1
  DC1Instance:
    Description: EC2 instance type for the nodes in the 2nd Data Center.
    Type: String
    AllowedValues:
      - t2.medium
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - i3.xlarge
      - i3.2xlarge
      - i3.4xlarge
      - r5.large
      - r5.xlarge
      - r5.2xlarge
      - r5.4xlarge
      - r5.8xlarge
    Default: r5.2xlarge
  DC1VolumeSize:
    Description: The EBS volume size, in GiB, for the nodes in 2nd datacenter.
    Type: Number
    AllowedValues:
      - 1024
      - 2048
    Default: 1024
  DC1Search:
    Description: True if this is a search DC
    Type: String
    AllowedValues:
      - True
      - False
    Default: False
  DC1Analytics:
    Description: True if this is an analytics DC
    Type: String
    AllowedValues:
      - True
      - False
    Default: False
  ClusterName:
    Description: The name of the DSE cluster. This is the name used by DSE OpsCenter.
    Type: String
    Default: DSE Cluster
  OpsCenterInstanceType:
    Description: Node EC2 instance type
    Type: String
    Default: r5.2xlarge
    AllowedValues:
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - r5.large
      - r5.xlarge
      - r5.2xlarge
    ConstraintDescription: must be a valid EC2 instance type.
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen
      (-).
    Default: aws-quickstart
    Description: S3 bucket name for the Quick Start assets. Quick Start bucket name
      can include numbers, lowercase letters, uppercase letters, and hyphens (-).
      It cannot start or end with a hyphen (-).
    Type: String
  QSS3BucketRegion:
    Default: 'us-east-1'
    Description: 'The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is hosted. When using your own bucket, you must specify this value.'
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-/]*$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/).
    Default: quickstart-datastax/
    Description: S3 key prefix for the Quick Start assets. Quick Start key prefix
      can include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/).
    Type: String
Conditions:
  GovCloudCondition: !Equals
    - !Ref 'AWS::Region'
    - us-gov-west-1
  CreateDC1: !Not
    - !Equals
      - !Ref 'DC1Size'
      - 0
  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'aws-quickstart']
Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
    DeletionPolicy: Delete
  S3RoleOpsC:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
  S3RolePoliciesOpsC:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: s3-access
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:DeleteObject
              - s3:PutObject
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref 'S3Bucket'
                - /*
          - Effect: Allow
            Action:
              - s3:ListBucket
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref 'S3Bucket'
      Roles:
        - !Ref 'S3RoleOpsC'
  S3ProfileOpsC:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref 'S3RoleOpsC'
  S3RoleNode:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
  S3RolePoliciesNode:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: s3-access
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref 'S3Bucket'
                - /*
      Roles:
        - !Ref 'S3RoleNode'
  S3ProfileNode:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref 'S3RoleNode'
  VPCstack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        !Sub
          - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/quickstart-aws-vpc/templates/aws-vpc.template.yaml'
          - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        AvailabilityZones: !Join
          - ','
          - !Ref 'AvailabilityZones'
        NumberOfAZs: '3'
        CreatePrivateSubnets: 'true'
  OpsCSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable SSH access, and OpsCenter port
      VpcId: !GetAtt 'VPCstack.Outputs.VPCID'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref 'AccessLocation'
        - IpProtocol: tcp
          FromPort: 8443
          ToPort: 8443
          CidrIp: !Ref 'AccessLocation'
        - IpProtocol: tcp
          FromPort: 8888
          ToPort: 8888
          CidrIp: !GetAtt 'VPCstack.Outputs.VPCCIDR'
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !GetAtt 'VPCstack.Outputs.VPCCIDR'
        - IpProtocol: tcp
          FromPort: 61620
          ToPort: 61620
          CidrIp: !GetAtt 'VPCstack.Outputs.VPCCIDR'
    DependsOn: VPCstack
  OpsCenterstack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        !Sub
          - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/opscenter.template'
          - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        KeyName: !Ref 'KeyName'
        OpsCenterSecurityGroupId: !GetAtt 'OpsCSecurityGroup.GroupId'
        SubnetId: !GetAtt 'VPCstack.Outputs.PublicSubnet1ID'
        ClusterName: !Ref 'ClusterName'
        DC0Size: !Ref 'DC0Size'
        DC1Size: !Ref 'DC1Size'
        DSEVersion: !Ref 'DSEVersion'
        DSAcademyUser: !Ref 'DSAcademyUser'
        DSAcademyPW: !Ref 'DSAcademyPW'
        DBPassword: !Ref 'DBPassword'
        OpsCPassword: !Ref 'OpsCPassword'
        Profile: !Ref 'S3ProfileOpsC'
        S3Bucket: !Ref 'S3Bucket'
        InstanceType: !Ref 'OpsCenterInstanceType'
    DependsOn: VPCstack
  DC0stack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        !Sub
          - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/datacenter.template'
          - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        KeyName: !Ref 'KeyName'
        Profile: !Ref 'S3ProfileNode'
        S3Bucket: !Ref 'S3Bucket'
        OpsCenterIP: !GetAtt 'OpsCenterstack.Outputs.OpsCenterPrivateIP'
        OpsCPassword: !Ref 'OpsCPassword'
        ClusterName: !Ref 'ClusterName'
        DataCenterName: !Ref 'DC0Name'
        DataCenterSize: !Ref 'DC0Size'
        InstanceType: !Ref 'DC0Instance'
        VolumeSize: !Ref 'DC0VolumeSize'
        VPC: !GetAtt 'VPCstack.Outputs.VPCID'
        Search: !Ref 'DC0Search'
        Analytics: !Ref 'DC0Analytics'
        AvailabilityZones: !Join
          - ','
          - !Ref 'AvailabilityZones'
        Subnets: !Join
          - ','
          - - !GetAtt 'VPCstack.Outputs.PrivateSubnet1AID'
            - !GetAtt 'VPCstack.Outputs.PrivateSubnet2AID'
            - !GetAtt 'VPCstack.Outputs.PrivateSubnet3AID'
        SecurityCIDR: !GetAtt 'VPCstack.Outputs.VPCCIDR'
    DependsOn: VPCstack
  DC1stack:
    Type: AWS::CloudFormation::Stack
    Condition: CreateDC1
    Properties:
      TemplateURL:
        !Sub
          - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/datacenter.template'
          - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        KeyName: !Ref 'KeyName'
        Profile: !Ref 'S3ProfileNode'
        S3Bucket: !Ref 'S3Bucket'
        OpsCenterIP: !GetAtt 'OpsCenterstack.Outputs.OpsCenterPrivateIP'
        OpsCPassword: !Ref 'OpsCPassword'
        ClusterName: !Ref 'ClusterName'
        DataCenterName: !Ref 'DC1Name'
        DataCenterSize: !Ref 'DC1Size'
        InstanceType: !Ref 'DC1Instance'
        VolumeSize: !Ref 'DC1VolumeSize'
        VPC: !GetAtt 'VPCstack.Outputs.VPCID'
        Search: !Ref 'DC1Search'
        Analytics: !Ref 'DC1Analytics'
        AvailabilityZones: !Join
          - ','
          - !Ref 'AvailabilityZones'
        Subnets: !Join
          - ','
          - - !GetAtt 'VPCstack.Outputs.PrivateSubnet1AID'
            - !GetAtt 'VPCstack.Outputs.PrivateSubnet2AID'
            - !GetAtt 'VPCstack.Outputs.PrivateSubnet3AID'
        SecurityCIDR: !GetAtt 'VPCstack.Outputs.VPCCIDR'
    DependsOn: VPCstack
Outputs:
  OpsCenterURL:
    Value: !GetAtt 'OpsCenterstack.Outputs.OpsCenterURL'
  OpsCenterPublicIP:
    Value: !GetAtt 'OpsCenterstack.Outputs.OpsCenterPublicIP'
    Description: Public IP for OpsCenter
  VPCstackRef:
    Value: !Ref 'VPCstack'
